####################################################################################
# patch to make output thumbnails use the frame number of the input
# file *instead* of an ever-incrementing rather meaningless counter
#
#   tracey jan2011 (last update: mar2012)
# 
####################################################################################
diff --git a/ffmpeg.c b/ffmpeg.c
index a97327b..5f8d43b 100644
--- a/ffmpeg.c
+++ b/ffmpeg.c
@@ -1873,13 +1873,14 @@ static void do_video_out(AVFormatContext *s,
     }
 
 
+    s->ist_frame_number = ist->st->codec->frame_number;
 duplicate_frame:
     av_init_packet(&pkt);
     pkt.data = NULL;
     pkt.size = 0;
 
     in_picture->pts = ost->sync_opts;
-
+     
     if (s->oformat->flags & AVFMT_RAWPICTURE &&
         enc->codec->id == CODEC_ID_RAWVIDEO) {
         /* raw pictures are written as AVPicture structure to
diff --git a/libavformat/avformat.h b/libavformat/avformat.h
index 5a11fdc..f9ad381 100644
--- a/libavformat/avformat.h
+++ b/libavformat/avformat.h
@@ -1093,0 +1094 @@ typedef struct AVFormatContext {
+    int ist_frame_number;
diff --git a/libavformat/img2enc.c b/libavformat/img2enc.c
index 9b4b30e..e8abc7d 100644
--- a/libavformat/img2enc.c
+++ b/libavformat/img2enc.c
@@ -66,7 +66,7 @@ static int write_packet(AVFormatContext *s, AVPacket *pkt)
 
     if (!img->is_pipe) {
         if (av_get_frame_filename(filename, sizeof(filename),
-                                  img->path, img->img_number) < 0 && img->img_number>1 && !img->updatefirst) {
+                                  img->path, (s->ist_frame_number ? s->ist_frame_number : img->img_number)) < 0 && img->img_number>1 && !img->updatefirst) {
             av_log(s, AV_LOG_ERROR,
                    "Could not get frame filename number %d from pattern '%s'\n",
                    img->img_number, img->path);
